<!DOCTYPE html>
<html lang=zh>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000">
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top">
  
  
  <title>基于Logstash、ElasticSearch的全文检索平台 | Duckyrain的博客</title>
  <meta name="description" content="“带着问题去研究技术，在钻研过程中你会遇到更多的问题，但当这些问题逐一被解决的时候，就是你获得成就感的时候。” 背景笔者目前负责的项目主要是移动运营商相关业务，由于各省运营商都是独立运营，存在不同的对接规范，另外对接时间点和对接人都不同，就造成了前期数据结构甚至是数据表上的一些差异，比如运营商用户开销户数据。 早期项目比较少的时候，我们提供业务数据查询平台的方式是，针对每个项目部署一套查询平台，数">
<meta name="keywords" content="SpringBoot,ElasticSearch,Logstash">
<meta property="og:type" content="article">
<meta property="og:title" content="基于Logstash、ElasticSearch的全文检索平台">
<meta property="og:url" content="https://amaging.cn/2018/07/22/基于ElasticSearch的全文检索平台/index.html">
<meta property="og:site_name" content="DuckyRain的博客">
<meta property="og:description" content="“带着问题去研究技术，在钻研过程中你会遇到更多的问题，但当这些问题逐一被解决的时候，就是你获得成就感的时候。” 背景笔者目前负责的项目主要是移动运营商相关业务，由于各省运营商都是独立运营，存在不同的对接规范，另外对接时间点和对接人都不同，就造成了前期数据结构甚至是数据表上的一些差异，比如运营商用户开销户数据。 早期项目比较少的时候，我们提供业务数据查询平台的方式是，针对每个项目部署一套查询平台，数">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://amaging.cn/2018/07/22/基于ElasticSearch的全文检索平台/1.png">
<meta property="og:image" content="https://amaging.cn/2018/07/22/基于ElasticSearch的全文检索平台/2.png">
<meta property="og:updated_time" content="2019-04-15T09:45:54.857Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="基于Logstash、ElasticSearch的全文检索平台">
<meta name="twitter:description" content="“带着问题去研究技术，在钻研过程中你会遇到更多的问题，但当这些问题逐一被解决的时候，就是你获得成就感的时候。” 背景笔者目前负责的项目主要是移动运营商相关业务，由于各省运营商都是独立运营，存在不同的对接规范，另外对接时间点和对接人都不同，就造成了前期数据结构甚至是数据表上的一些差异，比如运营商用户开销户数据。 早期项目比较少的时候，我们提供业务数据查询平台的方式是，针对每个项目部署一套查询平台，数">
<meta name="twitter:image" content="https://amaging.cn/2018/07/22/基于ElasticSearch的全文检索平台/1.png">
  <!-- Canonical links -->
  <link rel="canonical" href="https://amaging.cn/2018/07/22/基于ElasticSearch的全文检索平台/index.html">
  
    <link rel="alternate" href="/atom.xml" title="DuckyRain的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  <link rel="stylesheet" href="/css/style.css">
  
  
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitment@0.0.3/style/default.min.css">
  
  
  
</head>


<body class="main-center theme-purple" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope="" itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://github.com/duckyrain" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">DuckyRain</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">高级Java &amp; 系统架构</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> 北京, 中国</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索">
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech="">
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope="" itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav ">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">项目</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">关于</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/duckyrain" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://weibo.com/duqiyu2151" target="_blank" title="Weibo" data-toggle="tooltip" data-placement="top"><i class="icon icon-weibo"></i></a></li>
        
        <li><a href="https://twitter.com/duqiyu2151" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top"><i class="icon icon-twitter"></i></a></li>
        
        <li><a href="/" target="_blank" title="Facebook" data-toggle="tooltip" data-placement="top"><i class="icon icon-facebook"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope="" itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>欢迎交流与分享经验!</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/其他/">其他</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/规范/">规范</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/调优/">调优</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/API/">API</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CentOS/">CentOS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ElasticSearch/">ElasticSearch</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/">Git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GitLab/">GitLab</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JDK/">JDK</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Logstash/">Logstash</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Netty/">Netty</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RESTful/">RESTful</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringBoot/">SpringBoot</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Springboot/">Springboot</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TCP/">TCP</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/github/">github</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/springboot/">springboot</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/其他/">其他</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/源码解析/">源码解析</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网络/">网络</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/规范/">规范</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a><span class="tag-list-count">6</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/API/" style="font-size: 13px;">API</a> <a href="/tags/CentOS/" style="font-size: 13px;">CentOS</a> <a href="/tags/ElasticSearch/" style="font-size: 13px;">ElasticSearch</a> <a href="/tags/Git/" style="font-size: 13px;">Git</a> <a href="/tags/GitLab/" style="font-size: 13px;">GitLab</a> <a href="/tags/JDK/" style="font-size: 13.25px;">JDK</a> <a href="/tags/Java/" style="font-size: 14px;">Java</a> <a href="/tags/Logstash/" style="font-size: 13px;">Logstash</a> <a href="/tags/Netty/" style="font-size: 13px;">Netty</a> <a href="/tags/Nginx/" style="font-size: 13px;">Nginx</a> <a href="/tags/RESTful/" style="font-size: 13px;">RESTful</a> <a href="/tags/SpringBoot/" style="font-size: 13px;">SpringBoot</a> <a href="/tags/Springboot/" style="font-size: 13px;">Springboot</a> <a href="/tags/TCP/" style="font-size: 13.25px;">TCP</a> <a href="/tags/github/" style="font-size: 13.75px;">github</a> <a href="/tags/java/" style="font-size: 13px;">java</a> <a href="/tags/springboot/" style="font-size: 13px;">springboot</a> <a href="/tags/其他/" style="font-size: 13.5px;">其他</a> <a href="/tags/源码解析/" style="font-size: 13.25px;">源码解析</a> <a href="/tags/网络/" style="font-size: 13px;">网络</a> <a href="/tags/规范/" style="font-size: 13.25px;">规范</a> <a href="/tags/设计模式/" style="font-size: 13.75px;">设计模式</a>
    </div>
  </div>

    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/其他/">其他</a>
              </p>
              <p class="item-title">
                <a href="/2019/09/19/科学上网 r2ray篇/" class="title">科学上网 shadowsocks（已被墙）</a>
              </p>
              <p class="item-date">
                <time datetime="2019-09-19T12:20:03.000Z" itemprop="datePublished">2019-09-19</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/其他/">其他</a>
              </p>
              <p class="item-title">
                <a href="/2019/02/07/科学上网shadowsocks篇/" class="title">科学上网 shadowsocks（已被墙）</a>
              </p>
              <p class="item-date">
                <time datetime="2019-02-06T18:30:03.000Z" itemprop="datePublished">2019-02-07</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/调优/">调优</a>
              </p>
              <p class="item-title">
                <a href="/2019/01/25/一次服务端性能优化/" class="title">一次服务端性能优化</a>
              </p>
              <p class="item-date">
                <time datetime="2019-01-25T11:50:00.000Z" itemprop="datePublished">2019-01-25</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/规范/">规范</a>
              </p>
              <p class="item-title">
                <a href="/2018/12/15/从零构建一个springboot多模块项目/" class="title">从零构建一个springboot多模块项目</a>
              </p>
              <p class="item-date">
                <time datetime="2018-12-15T13:13:00.000Z" itemprop="datePublished">2018-12-15</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/其他/">其他</a>
              </p>
              <p class="item-title">
                <a href="/2018/07/30/个人工作软件插件汇总/" class="title">个人工作软件/插件汇总</a>
              </p>
              <p class="item-date">
                <time datetime="2018-07-30T12:20:23.000Z" itemprop="datePublished">2018-07-30</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope="" itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#背景"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#问题"><span class="toc-number">2.</span> <span class="toc-text">问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ElasticSearch"><span class="toc-number">3.</span> <span class="toc-text">ElasticSearch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Logstash"><span class="toc-number">4.</span> <span class="toc-text">Logstash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kibana"><span class="toc-number">5.</span> <span class="toc-text">kibana</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基于SpringBoot的es全文检索平台"><span class="toc-number">6.</span> <span class="toc-text">基于SpringBoot的es全文检索平台</span></a></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-基于ElasticSearch的全文检索平台" class="article article-type-post" itemscope="" itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      基于Logstash、ElasticSearch的全文检索平台
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2018/07/22/基于ElasticSearch的全文检索平台/" class="article-date">
	  <time datetime="2018-07-22T10:20:23.000Z" itemprop="datePublished">2018-07-22</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/Java/">Java</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link" href="/tags/ElasticSearch/">ElasticSearch</a>, <a class="article-tag-link" href="/tags/Logstash/">Logstash</a>, <a class="article-tag-link" href="/tags/SpringBoot/">SpringBoot</a>
  </span>


        
	<span class="article-read hidden-xs">
	    <i class="icon icon-eye-fill" aria-hidden="true"></i>
	    <span id="busuanzi_container_page_pv">
			<span id="busuanzi_value_page_pv">0</span>
		</span>
	</span>


        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2018/07/22/基于ElasticSearch的全文检索平台/#comments" class="article-comment-link">评论</a></span>
        
      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <p>“<em>带着问题去研究技术，在钻研过程中你会遇到更多的问题，但当这些问题逐一被解决的时候，就是你获得成就感的时候。</em>”</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>笔者目前负责的项目主要是移动运营商相关业务，由于各省运营商都是独立运营，存在不同的对接规范，另外对接时间点和对接人都不同，就造成了前期数据结构甚至是数据表上的一些差异，比如运营商用户开销户数据。</p>
<p>早期项目比较少的时候，我们提供业务数据查询平台的方式是，针对每个项目部署一套查询平台，数据源直接是MySql。但随着项目越来越多，数据量越来越大，使用人员在平台和功能间来回进行切换就显得越来越繁琐，另外使用MySql直接进行百万级甚至千万级的数据量查询，显然效率是跟不上的。</p>
<p>所以笔者就想，能不能做一套类似baidu的直观简单的全文检索平台，一是不用再通过切换平台完成不同项目的数据查询，二是不再使用传统的多查询框，而只是提供一个查询框。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>首先笔者面临的是两个基本问题：</p>
<ol>
<li><strong>分库问题</strong>。不同的项目数据库部署在不同的IDC机房，如何提供统一的数据源；</li>
<li><strong>分表问题</strong>。不同的业务数据存储在不同的数据表中，不同的业务表数据如何实现全文检索。</li>
</ol>
<p>通过技术选型，发现Logstash和ElasticSearch可以完成这个目标：<strong>通过Logstash定时采集Mysql的增量和更新数据，推送到ElasticSearch中，而ES提供的丰富的API能直接实现自定义的全文检索功能</strong>。</p>
<h2 id="ElasticSearch"><a href="#ElasticSearch" class="headerlink" title="ElasticSearch"></a>ElasticSearch</h2><p><em>注：笔者用到的ELK（ElasticSearch + Logstash + Kibana）版本是6.2.3，本文不介绍ELK的安装方法，具体安装请自行Google。ElasticSearch集群的安装部署相对比较繁琐，可能需要调整服务器的一些配置参数，有条件的同学，建议直接使用docker镜像进行部署。</em></p>
<p>在ES5.0之前，网上很多人对es数据结构中的index和type给了简单解释，认为index等同于关系型数据库中的一个库，type等同于库中的表，这种错误的解释误导了不少人。</p>
<p><strong>注意：从现在起，抛弃ES中type的概念，ES6已经将type进行了约束，一个index只允许创建一个type，因此，将type当作是关系型数据库中的数据表，显然是不成立的，另外，ES7将直接移除type属性。</strong></p>
<p>那么我们如何建立与mysql数据表对应的索引呢，举个例子，我们有5个项目，每个项目有5张业务表，那么我们就可以创建5×5个索引（<em>实际应用中，因为数据量较大，我们可能还会对RDBMS做更细的shard表，如tableA1,tableA2,…,tableA10，这种为解决RDBMS中海量数据存储而人为添加的shard表，可以不用再在es中通过索引区分，es单个索引默认5个分片，一个分片最大数据量20亿，基本上满足常规数据需求了，如果真有百亿级数据需求，可能就需要进行索引分片配置优化了。</em>），如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">   projectA_tableA</span><br><span class="line">projectA_tableB</span><br><span class="line">projectA_tableC</span><br><span class="line">projectA_tableD</span><br><span class="line">projectA_tableE</span><br><span class="line">...</span><br><span class="line">   projectE_tableA</span><br><span class="line">projectE_tableB</span><br><span class="line">projectE_tableC</span><br><span class="line">projectE_tableD</span><br><span class="line">projectE_tableE</span><br></pre></td></tr></table></figure>
<p>因为ES是支持索引模糊匹配的，所以通过上面我们建立的project_table索引形式，已经可以满足我们的检索需求了，如：</p>
<ul>
<li>查询A项目下的所有数据： GET /projectA_*</li>
<li>查询所有项目的tableC数据： GET /*_tableC</li>
</ul>
<p>数据索引结构设计完成，开始进行数据采集工作。</p>
<h2 id="Logstash"><a href="#Logstash" class="headerlink" title="Logstash"></a>Logstash</h2><p>Logstash是一款开源的服务器端数据处理管道，能够同时从多个来源采集数据、转换数据，并将数据发送到 “存储库” 中，本文中我们使用es进行存储。</p>
<p>一个相对完整的logstash的jdbc脚本配置示例如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">input &#123;</span><br><span class="line">    # 标准输入，这里可以针对输入内容添加field、tags、type等属性，对于日志文件或数据库形式的数据源，通常不会用到stdin</span><br><span class="line">    stdin &#123;</span><br><span class="line">        # 添加数据域，也就是字段</span><br><span class="line">        add_field =&gt; &#123;"key" =&gt; "value"&#125;</span><br><span class="line">        # 编码插件(Coder/decoder缩写)，在输入期中用于处理不同类型的数据，如json。</span><br><span class="line">        codec =&gt; "plain"</span><br><span class="line">        # logstash中的特殊字段，可理解为标签</span><br><span class="line">        tags =&gt; ["add"]</span><br><span class="line">        # logstash中的特殊字段，用于标记事件类型</span><br><span class="line">        type =&gt; "std"</span><br><span class="line">    &#125;</span><br><span class="line">    jdbc &#123;</span><br><span class="line">      # mysql相关jdbc配置</span><br><span class="line">      jdbc_connection_string =&gt; "jdbc:mysql://127.0.0.1:3306/your_mysql_database"</span><br><span class="line">      jdbc_user =&gt; "mysql_user"</span><br><span class="line">      jdbc_password =&gt; "mysql_password"</span><br><span class="line"></span><br><span class="line">      # jdbc连接mysql驱动的文件目录</span><br><span class="line">      jdbc_driver_library =&gt; "/opt/logstash/conf/mysql-connector-java/mysql-connector-java-5.1.44-bin.jar"</span><br><span class="line">      jdbc_driver_class =&gt; "com.mysql.jdbc.Driver"</span><br><span class="line"></span><br><span class="line">      # 分页，数据量较大的情况下不要使用，建议自己通过sql语句做分页，因为这里是将所有数据全部查出，然后再进行limit，效率非常低</span><br><span class="line">      jdbc_paging_enabled =&gt; "true"</span><br><span class="line">      jdbc_page_size =&gt; "50000"</span><br><span class="line"></span><br><span class="line">      # mysql文件, 也可以直接写SQL语句在此处，如下：</span><br><span class="line">      # statement =&gt; "SELECT * from Table_test;"</span><br><span class="line">      statement_filepath =&gt; "/opt/logstash/conf/jdbc.sql"</span><br><span class="line"></span><br><span class="line">      # 这里类似crontab，可以定制定时操作，比如每10分钟执行一次同步(分 时 天 月 年)</span><br><span class="line">      schedule =&gt; "*/10 * * * *"</span><br><span class="line">      type =&gt; "jdbc"</span><br><span class="line"></span><br><span class="line">      # 是否记录上次执行结果, 如果为真,将会把上次执行到的 tracking_column 字段的值记录下来,保存到 last_run_metadata_path 指定的文件中</span><br><span class="line">      record_last_run =&gt; "true"</span><br><span class="line"></span><br><span class="line">      # 是否需要记录某个column 的值,如果record_last_run为真,可以自定义我们需要 track 的 column 名称，此时该参数就要为 true. 否则默认 track 的是 timestamp 的值.</span><br><span class="line">      use_column_value =&gt; "true"</span><br><span class="line"></span><br><span class="line">      # 如果 use_column_value 为真,需配置此参数. track 的数据库 column 名,该 column 必须是递增的. 一般是mysql主键</span><br><span class="line">      tracking_column =&gt; "autoid"</span><br><span class="line"></span><br><span class="line">      last_run_metadata_path =&gt; "/opt/logstash/conf/last_id"</span><br><span class="line"></span><br><span class="line">      # 是否清除 last_run_metadata_path 的记录,如果为真那么每次都相当于从头开始查询所有的数据库记录</span><br><span class="line">      clean_run =&gt; "false"</span><br><span class="line"></span><br><span class="line">      # 是否将 字段(column) 名称转小写</span><br><span class="line">      lowercase_column_names =&gt; "false"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># logstash过滤器，可对数据进行复杂逻辑处理，如数据格式转换、改写、添加新数据等</span><br><span class="line">filter &#123;&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    # 这里输出调试，正式运行时可以注释掉</span><br><span class="line">    stdout &#123;</span><br><span class="line">        codec =&gt; json_lines</span><br><span class="line">    &#125;</span><br><span class="line">    # 输出到elasticsearch的配置</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        hosts =&gt; ["127.0.0.1:9200","127.0.0.1:9201","127.0.0.1:9202"]</span><br><span class="line">        index =&gt; "jdbc"</span><br><span class="line">        # 将"_id"的值设为mysql的autoid字段</span><br><span class="line">        document_id =&gt; "%&#123;autoid&#125;"</span><br><span class="line">        # 注意：es6以后，不再推荐使用type，es7将直接去除type。</span><br><span class="line">        # document_type =&gt; "doc"</span><br><span class="line">        template_overwrite =&gt; true</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述示例给出了最基本的mysql数据表同步示例，但现在的数据同步还面临几个问题：</p>
<ol>
<li>示例给出的仅仅是对一张表的增量数据进行的处理，而更新的数据，自增主键是不会变化的，需要如何处理？</li>
<li>一个项目中我们往往有多张业务表，不可能我们有10张业务表就需要写20个配置文件（增量数据配置和更新数据配置），启动20个logstash实例，有没有解决办法？</li>
<li>对于MySQL中删除的数据，如何通过logstash同步到es中？</li>
</ol>
<p>对于第一个问题，logstash提供了根据timestamp更新数据的方案，通过track业务表中的update_time值，就能完成数据的更新操作了，如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">jdbc &#123;</span><br><span class="line">    # 这个type不是es数据结构中的type，注意不要混淆，后面会讲到用途</span><br><span class="line">    type =&gt; "user_info"</span><br><span class="line">    jdbc_connection_string =&gt; "jdbc:mysql://127.0.0.1:3306/mytest"</span><br><span class="line">    jdbc_user =&gt; "root"</span><br><span class="line">    jdbc_password =&gt; "qwer1234"</span><br><span class="line">    jdbc_driver_library =&gt; "/opt/soft/logstash-script/mysql-connector-java-5.1.43.jar"</span><br><span class="line">    jdbc_driver_class =&gt; "com.mysql.jdbc.Driver"</span><br><span class="line">    # 这里我们单独写了一条sql，用于查询某一时间点之后有过更新的所有数据</span><br><span class="line">    statement_filepath =&gt; "/opt/soft/logstash-script/user_info_update.sql"</span><br><span class="line">    schedule =&gt; "* * * * *"</span><br><span class="line">    record_last_run =&gt; "true"</span><br><span class="line">    use_column_value =&gt; "true"</span><br><span class="line">    # track的字段类型为时间戳</span><br><span class="line">    tracking_column_type =&gt; "timestamp"</span><br><span class="line">    # 对于数据库中的update_time字段</span><br><span class="line">    tracking_column =&gt; "update_time"</span><br><span class="line">    # 记录最后一条记录的update_time值，作为下一次sql语句执行的时间点</span><br><span class="line">    last_run_metadata_path =&gt; "/opt/soft/logstash-script/user_info_update.lastValue"</span><br><span class="line">    clean_run =&gt; "false"</span><br><span class="line">    lowercase_column_names =&gt; "false"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于第二个问题，庆幸的是，logstash允许我们在input中同时定义多个数据源（如file,jdbc等），如下，通过单个input的配置，我们实现了两张业务表的数据的新增和更新同步功能：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">input &#123;</span><br><span class="line">    #stdin &#123;&#125;</span><br><span class="line"></span><br><span class="line">    jdbc &#123;</span><br><span class="line">        type =&gt; "user_info"</span><br><span class="line">        jdbc_connection_string =&gt; "jdbc:mysql://10.55.130.200:3306/ibcp"</span><br><span class="line">        jdbc_user =&gt; "gitv_rd"</span><br><span class="line">        jdbc_password =&gt; "1234.gitv_rd"</span><br><span class="line">        jdbc_driver_library =&gt; "/opt/soft/logstash-script/mysql-connector-java-5.1.43.jar"</span><br><span class="line">        jdbc_driver_class =&gt; "com.mysql.jdbc.Driver"</span><br><span class="line">        statement_filepath =&gt; "/opt/soft/logstash-script/user_info.sql"</span><br><span class="line">        schedule =&gt; "*/5 * * * *"</span><br><span class="line">        record_last_run =&gt; "true"</span><br><span class="line">        use_column_value =&gt; "true"</span><br><span class="line">        tracking_column_type =&gt; "numeric"</span><br><span class="line">        tracking_column =&gt; "id"</span><br><span class="line">        last_run_metadata_path =&gt; "/opt/soft/logstash-script/user_info.lastValue"</span><br><span class="line">        clean_run =&gt; "false"</span><br><span class="line">        lowercase_column_names =&gt; "false"</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    jdbc &#123;</span><br><span class="line">        type =&gt; "user_info"</span><br><span class="line">        jdbc_connection_string =&gt; "jdbc:mysql://10.55.130.200:3306/ibcp"</span><br><span class="line">        jdbc_user =&gt; "gitv_rd"</span><br><span class="line">        jdbc_password =&gt; "1234.gitv_rd"</span><br><span class="line">        jdbc_driver_library =&gt; "/opt/soft/logstash-script/mysql-connector-java-5.1.43.jar"</span><br><span class="line">        jdbc_driver_class =&gt; "com.mysql.jdbc.Driver"</span><br><span class="line">        statement_filepath =&gt; "/opt/soft/logstash-script/user_info_update.sql"</span><br><span class="line">        schedule =&gt; "*/5 * * * *"</span><br><span class="line">        record_last_run =&gt; "true"</span><br><span class="line">        use_column_value =&gt; "true"</span><br><span class="line">        tracking_column_type =&gt; "timestamp"</span><br><span class="line">        tracking_column =&gt; "update_time"</span><br><span class="line">        last_run_metadata_path =&gt; "/opt/soft/logstash-script/user_info_update.lastValue"</span><br><span class="line">        clean_run =&gt; "false"</span><br><span class="line">        lowercase_column_names =&gt; "false"</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    jdbc &#123;</span><br><span class="line">        type =&gt; "user_active"</span><br><span class="line">        jdbc_connection_string =&gt; "jdbc:mysql://10.55.130.200:3306/ibcp"</span><br><span class="line">        jdbc_user =&gt; "gitv_rd"</span><br><span class="line">        jdbc_password =&gt; "1234.gitv_rd"</span><br><span class="line">        jdbc_driver_library =&gt; "/opt/soft/logstash-script/mysql-connector-java-5.1.43.jar"</span><br><span class="line">        jdbc_driver_class =&gt; "com.mysql.jdbc.Driver"</span><br><span class="line">        statement_filepath =&gt; "/opt/soft/logstash-script/user_active.sql"</span><br><span class="line">        schedule =&gt; "*/5 * * * *"</span><br><span class="line">        record_last_run =&gt; "true"</span><br><span class="line">        use_column_value =&gt; "true"</span><br><span class="line">        tracking_column_type =&gt; "numeric"</span><br><span class="line">        tracking_column =&gt; "id"</span><br><span class="line">        last_run_metadata_path =&gt; "/opt/soft/logstash-script/user_active.lastValue"</span><br><span class="line">        clean_run =&gt; "false"</span><br><span class="line">        lowercase_column_names =&gt; "false"</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    jdbc &#123;</span><br><span class="line">        type =&gt; "user_active"</span><br><span class="line">        jdbc_connection_string =&gt; "jdbc:mysql://10.55.130.200:3306/ibcp"</span><br><span class="line">        jdbc_user =&gt; "gitv_rd"</span><br><span class="line">        jdbc_password =&gt; "1234.gitv_rd"</span><br><span class="line">        jdbc_driver_library =&gt; "/opt/soft/logstash-script/mysql-connector-java-5.1.43.jar"</span><br><span class="line">        jdbc_driver_class =&gt; "com.mysql.jdbc.Driver"</span><br><span class="line">        statement_filepath =&gt; "/opt/soft/logstash-script/user_active_update.sql"</span><br><span class="line">        schedule =&gt; "*/5 * * * *"</span><br><span class="line">        record_last_run =&gt; "true"</span><br><span class="line">        use_column_value =&gt; "true"</span><br><span class="line">        tracking_column_type =&gt; "timestamp"</span><br><span class="line">        tracking_column =&gt; "update_time"</span><br><span class="line">        last_run_metadata_path =&gt; "/opt/soft/logstash-script/user_active_update.lastValue"</span><br><span class="line">        clean_run =&gt; "false"</span><br><span class="line">        lowercase_column_names =&gt; "false"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但又带来了一个问题，output如何判断数据需要写入到哪个索引中呢。这个时候在jdbc{}中定义的type起到了作用，logstash语法同样也支持逻辑判断，所以我们可以通过判断type值，来决定数据源的去向。</p>
<p><em>注意：再强调一下，我们在jdbc{}中用到的type不是es数据结构中的type。</em></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    #stdout &#123;codec =&gt; json_lines&#125;</span><br><span class="line">    if [type] == "user_info" &#123;</span><br><span class="line">        elasticsearch &#123;</span><br><span class="line">            hosts =&gt; ["127.0.0.1:19200", "127.0.0.1:19201", "127.0.0.1:19202"]</span><br><span class="line">            index =&gt; "ahcmcc_user_info"</span><br><span class="line">            document_id =&gt; "%&#123;id&#125;"</span><br><span class="line">            template_overwrite =&gt; true</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else if [type] == "user_active" &#123;</span><br><span class="line">        elasticsearch &#123;</span><br><span class="line">            hosts =&gt; ["127.0.0.1:19200", "127.0.0.1:19201", "127.0.0.1:19202"]</span><br><span class="line">            index =&gt; "ahcmcc_user_active"</span><br><span class="line">            document_id =&gt; "%&#123;id&#125;"</span><br><span class="line">            template_overwrite =&gt; true</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于第三个问题，如何删除数据，目前暂时没有好的办法，比较可靠的办法是在mysql数据表中做优化，只做逻辑删除，不做物理删除。这里就不做深入了。</p>
<p>我们看看写入es中的数据文档结构：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    "_index": "ahcmcc_user_info", // 索引</span><br><span class="line">    "_type": "doc",	// 类型（logstash输出的数据默认为doc，es6以后不建议再使用_type）</span><br><span class="line">    "_id": "222241", // ID</span><br><span class="line">    "_version": 3, </span><br><span class="line">    "found": true, </span><br><span class="line">    "_source": &#123; // 文档基本内容（这里对应我们sql语句查询的数据）</span><br><span class="line">        "user_id": "1331????????84001", </span><br><span class="line">        "date_created": "20150904102740",  </span><br><span class="line">        "broadband_id": "183????5577", </span><br><span class="line">        "date_cancelled": "", </span><br><span class="line">        "city_name": "蚌埠市", </span><br><span class="line">        "create_time": "2015-09-04T02:27:40.000Z", </span><br><span class="line">        "type": "user_info", // 这里对于我们的input.jdbc中定义的type字段</span><br><span class="line">        "status": "开户", </span><br><span class="line">        "update_time": "2018-07-26T05:53:50.000Z", </span><br><span class="line">        "user_group": 2, </span><br><span class="line">        "@version": "1", </span><br><span class="line">        "password": "", </span><br><span class="line">        "business_group": 0, </span><br><span class="line">        "telephone": "", </span><br><span class="line">        "@timestamp": "2018-07-26T06:00:00.862Z", </span><br><span class="line">        "date_activated": "20160527225833", </span><br><span class="line">        "user_name": "", </span><br><span class="line">        "uid": "ahcmcc_user_info_222241", // 这里是通过filter模块添加的域，用于标识文档唯一id，因为不同业务表的自增主键id必然是会有重复的，这么做仅仅只是为了业务需要，不是必须的。 </span><br><span class="line">        "expand": "", </span><br><span class="line">        "id": 222241, </span><br><span class="line">        "area_code": "22001", </span><br><span class="line">        "stb_id": "38:fa:ca:5c:a6:0d", </span><br><span class="line">        "area_name": "蚌埠市区", </span><br><span class="line">        "city_code": "22001"</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里提供一条sql语句示例，需要注意的是，在做表联查时，务必要对自增主键id进行一次顺序排序，否则可能造成一批数据无法同步到es中，原因是每次执行完sql后，logstash记录的是最后一条数据的id值（:sql_last_value），下次执行时，按照sql的逻辑，就不会再查询id比最后一次记录要小的数据了，而进行数据表联查时，数据库是不能完全保证按照我们需要的自增主键ID进行排序的，笔者在这里遇到过坑。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">SELECT</span><br><span class="line">  c.id,</span><br><span class="line">  i.city_code,</span><br><span class="line">  i.city_name,</span><br><span class="line">  i.area_code,</span><br><span class="line">  i.area_name,</span><br><span class="line">  CONCAT_WS(&apos;&apos;, c.family_id, c.group_id) AS broadband_id,</span><br><span class="line">  c.user_id,</span><br><span class="line">  IF(LENGTH(c.group_id) = 0, 1, 2)       AS user_group,</span><br><span class="line">  0                                      AS business_group,</span><br><span class="line">  c.date_created,</span><br><span class="line">  c.date_activated,</span><br><span class="line">  c.date_cancelled,</span><br><span class="line">  c.`status`</span><br><span class="line">  m.mac_addr                             AS stb_id,</span><br><span class="line">  &apos;&apos;                                     AS user_name,</span><br><span class="line">  &apos;&apos;                                     AS telephone,</span><br><span class="line">  &apos;&apos;                                     AS `password`,</span><br><span class="line">  &apos;&apos;                                     AS expand,</span><br><span class="line">  c.create_time,</span><br><span class="line">  c.update_time</span><br><span class="line">FROM</span><br><span class="line">  cont_user_area_info AS i,</span><br><span class="line">  cont_user_child AS c</span><br><span class="line">  LEFT JOIN cont_user_mac AS m ON c.user_id = m.child_account_id</span><br><span class="line">  JOIN (SELECT id</span><br><span class="line">        FROM cont_user_child</span><br><span class="line">        where id &gt; :sql_last_value</span><br><span class="line">        LIMIT 10000) AS c2 ON c.id = c2.id</span><br><span class="line">WHERE</span><br><span class="line">  i.area_code = c.area_no</span><br><span class="line">ORDER BY c.id</span><br></pre></td></tr></table></figure>
<p>最后，我们有多个项目，多个数据库，这里我们针对每个数据库启动一个logstash实例即可达到预期目标。数据采集阶段完成。</p>
<h2 id="kibana"><a href="#kibana" class="headerlink" title="kibana"></a>kibana</h2><p>kibana在elk中相对就比较简单了，直接下载安装包，配置对应的es集群后启动，进行基本索引字段配置后即可使用，这里就不再介绍。</p>
<h2 id="基于SpringBoot的es全文检索平台"><a href="#基于SpringBoot的es全文检索平台" class="headerlink" title="基于SpringBoot的es全文检索平台"></a>基于SpringBoot的es全文检索平台</h2><p>其实通过kibana，我们已经能完成绝大部分的日常数据查询、聚类分析了，但平台的专业性相对较强，直接提供给非技术人员使用，还是有一定难度。于是笔者根据日常查询需求，借鉴了baidu的风格，做了一套比较简单的查询平台。平台的查询界面效果如下：</p>
<p><img src="1.png" alt="查询首页"></p>
<p><img src="2.png" alt="查询结果页"></p>
<p>JAVA后台示例代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Content.java</span></span><br><span class="line"><span class="meta">@Document</span>(indexName = <span class="string">"*"</span>, type = <span class="string">"doc"</span>, createIndex = <span class="keyword">false</span>)</span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@JsonNaming</span>(PropertyNamingStrategy.SnakeCaseStrategy.class)</span><br><span class="line"><span class="meta">@JsonSerialize</span>(include=JsonSerialize.Inclusion.NON_NULL)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Content</span> <span class="keyword">extends</span> <span class="title">BaseModel</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 省略</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BaseModel.java</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@JsonNaming</span>(PropertyNamingStrategy.SnakeCaseStrategy.class)</span><br><span class="line"><span class="meta">@JsonSerialize</span>(include=JsonSerialize.Inclusion.NON_NULL)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseModel</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="comment">// 索引名称+id构成的唯一id</span></span><br><span class="line">    <span class="keyword">private</span> String uid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ContentDao.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ContentDao</span> <span class="keyword">extends</span> <span class="title">ElasticsearchRepository</span>&lt;<span class="title">Content</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ContentService.java</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContentService</span> <span class="keyword">extends</span> <span class="title">AbstractService</span>&lt;<span class="title">Content</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(ContentService.class);</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ContentDao contentDao;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterable&lt;Content&gt; <span class="title">query</span><span class="params">(Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == params) &#123;</span><br><span class="line">            params = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> contentDao.search(<span class="keyword">super</span>.customQuery(params).build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AbstractService.java</span></span><br><span class="line"><span class="meta">@PropertySource</span>(value = <span class="string">"classpath:field.properties"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractService</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(AbstractService.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">protected</span> ElasticsearchTemplate template;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;field.content&#125;"</span>)</span><br><span class="line">    <span class="keyword">protected</span> String[] FIELD_CONTENT;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;field.product.package&#125;"</span>)</span><br><span class="line">    <span class="keyword">protected</span> String[] FIELD_PRODUCT_PACKAGE;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;field.product.user.order&#125;"</span>)</span><br><span class="line">    <span class="keyword">protected</span> String[] FIELD_PRODUCT_USER_ORDER;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;field.user.info&#125;"</span>)</span><br><span class="line">    <span class="keyword">protected</span> String[] FIELD_USER_INFO;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;field.user.active&#125;"</span>)</span><br><span class="line">    <span class="keyword">protected</span> String[] FIELD_USER_ACTIVE;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Iterable&lt;T&gt; <span class="title">query</span><span class="params">(Map&lt;String, Object&gt; params)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通用原生查询方法</span></span><br><span class="line"><span class="comment">     * withIndices: 索引</span></span><br><span class="line"><span class="comment">     * withFilter: 是否匹配</span></span><br><span class="line"><span class="comment">     * withQuery: 匹配程度（效率较低，这里不使用）</span></span><br><span class="line"><span class="comment">     * withFields: 返回域</span></span><br><span class="line"><span class="comment">     * withSort: 排序</span></span><br><span class="line"><span class="comment">     * withPageable: 分页</span></span><br><span class="line"><span class="comment">     * withHighlightFields: 高亮</span></span><br><span class="line"><span class="comment">     * addAggregation: 聚合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> params</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> NativeSearchQueryBuilder</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> NativeSearchQueryBuilder <span class="title">customQuery</span><span class="params">(Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class="line">        NativeSearchQueryBuilder builder = <span class="keyword">new</span> NativeSearchQueryBuilder();</span><br><span class="line">        String index = (String)params.get(SearchConstants.INDEX);</span><br><span class="line">        String type = (String)params.get(SearchConstants.TYPE);</span><br><span class="line">        String cond = (String)params.get(SearchConstants.COND);</span><br><span class="line">        String fields = (String)params.get(SearchConstants.FIELDS);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(index)) &#123; <span class="comment">// 自定义索引，支持多索引，“,”隔开，如ahcmcc*,sncmcc*</span></span><br><span class="line">            builder.withIndices(index.split(SearchConstants.SPLIT_COMMA));</span><br><span class="line">        &#125;</span><br><span class="line">        BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(type)) &#123; <span class="comment">// 自定义类型（注：不是es自带的_type，_type将在es7以后废除，这里通过自定义type进行业务类型区分）</span></span><br><span class="line">            boolQueryBuilder.must(QueryBuilders.termQuery(SearchConstants.TYPE, type));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 查询条件分析(重点部分)</span></span><br><span class="line">        String[] queryFields = <span class="keyword">this</span>.getQueryFields(type);</span><br><span class="line">        boolQueryBuilder = <span class="keyword">this</span>.conditionParser(boolQueryBuilder, cond, queryFields);</span><br><span class="line">        builder.withFilter(boolQueryBuilder);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotEmpty(fields)) &#123; <span class="comment">// 自定义返回域</span></span><br><span class="line">            builder.withFields(fields.split(SearchConstants.SPLIT_COMMA));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 自定义排序，默认id降序</span></span><br><span class="line">        List&lt;SortBuilder&gt; sortBuilderList = <span class="keyword">this</span>.sorts(params);</span><br><span class="line">        <span class="keyword">for</span> (SortBuilder sortBuilder : sortBuilderList) &#123;</span><br><span class="line">            builder.withSort(sortBuilder);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 自定义分页，默认：单页50条</span></span><br><span class="line">        builder.withPageable(<span class="keyword">this</span>.page(params));</span><br><span class="line">        builder.withSearchType(SearchType.DEFAULT);</span><br><span class="line">        <span class="keyword">return</span> builder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> NativeSearchQueryBuilder <span class="title">detailQuery</span><span class="params">(String uid)</span> </span>&#123;</span><br><span class="line">        NativeSearchQueryBuilder builder = <span class="keyword">new</span> NativeSearchQueryBuilder();</span><br><span class="line">        builder.withFilter(QueryBuilders.termQuery(SearchConstants.UID, uid));</span><br><span class="line">        <span class="keyword">return</span> builder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询条件分析器</span></span><br><span class="line"><span class="comment">     * 支持多条件查询，使用空格进行分割，如a b</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> BoolQueryBuilder <span class="title">conditionParser</span><span class="params">(BoolQueryBuilder bqb, String cond, String... fields)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(cond)) &#123;</span><br><span class="line">            <span class="keyword">return</span> bqb;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (String str : cond.split(<span class="string">" "</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isEmpty(str)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (str.charAt(<span class="number">0</span>) == SearchConstants.NOT) &#123;</span><br><span class="line">                bqb.mustNot(QueryBuilders.multiMatchQuery(str.substring(<span class="number">1</span>), fields).type(MultiMatchQueryBuilder.Type.PHRASE));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                bqb.must(QueryBuilders.multiMatchQuery(str, fields).type(MultiMatchQueryBuilder.Type.PHRASE));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bqb;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> PageRequest <span class="title">page</span><span class="params">(Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> pageNumber = (<span class="keyword">null</span> == params.get(SearchConstants.PAGE_NUMBER) ? <span class="number">0</span> : (<span class="keyword">int</span>) params.get(SearchConstants.PAGE_NUMBER));</span><br><span class="line">        <span class="keyword">int</span> pageSize = (<span class="keyword">null</span> == params.get(SearchConstants.PAGE_SIZE)) ? <span class="number">50</span> : (<span class="keyword">int</span>) params.get(SearchConstants.PAGE_SIZE);</span><br><span class="line">        <span class="keyword">return</span> PageRequest.of(pageNumber, pageSize);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> List&lt;SortBuilder&gt; <span class="title">sorts</span><span class="params">(Map&lt;String, Object&gt; params)</span> </span>&#123;</span><br><span class="line">        List&lt;SortBuilder&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        String sorts = (<span class="keyword">null</span> == params.get(SearchConstants.SORT)) ? SearchConstants.SORT_DEFAULT_FIELD : (String)params.get(<span class="string">"sort"</span>);</span><br><span class="line">        String[] array = sorts.split(SearchConstants.SPLIT_COMMA);</span><br><span class="line">        <span class="keyword">for</span> (String sort : array) &#123;</span><br><span class="line">            SortOrder sortOrder = SortOrder.ASC;</span><br><span class="line">            sort = sort.trim();</span><br><span class="line">            <span class="keyword">char</span> first = sort.charAt(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (first == SearchConstants.SORT_DESC) &#123;</span><br><span class="line">                sortOrder = SortOrder.DESC;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (first == SearchConstants.SORT_ASC || first == SearchConstants.SORT_DESC) &#123;</span><br><span class="line">                sort = sort.substring(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            list.add(SortBuilders.fieldSort(sort).order(sortOrder));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> String[] getQueryFields(String type) &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(type)) &#123;</span><br><span class="line">            <span class="keyword">return</span> FIELD_CONTENT;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">            <span class="keyword">case</span> SearchConstants.PRODUCT_PACKAGE:</span><br><span class="line">                <span class="keyword">return</span> FIELD_PRODUCT_PACKAGE;</span><br><span class="line">            <span class="keyword">case</span> SearchConstants.PRODUCT_USER_ORDER:</span><br><span class="line">                <span class="keyword">return</span> FIELD_PRODUCT_USER_ORDER;</span><br><span class="line">            <span class="keyword">case</span> SearchConstants.USER_INFO:</span><br><span class="line">                <span class="keyword">return</span> FIELD_USER_INFO;</span><br><span class="line">            <span class="keyword">case</span> SearchConstants.USER_ACTIVE:</span><br><span class="line">                <span class="keyword">return</span> FIELD_USER_ACTIVE;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> FIELD_CONTENT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://amaging.cn/2018/07/22/基于ElasticSearch的全文检索平台/" title="基于Logstash、ElasticSearch的全文检索平台" target="_blank" rel="external">https://amaging.cn/2018/07/22/基于ElasticSearch的全文检索平台/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://github.com/duckyrain" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://github.com/duckyrain" target="_blank"><span class="text-dark">DuckyRain</span><small class="ml-1x">高级Java &amp; 系统架构</small></a></h3>
        <div></div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	

    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom="">
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2018/07/30/个人工作软件插件汇总/" title="个人工作软件/插件汇总"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2018/04/22/TCP的11种状态、连接以及断开过程/" title="TCP的11种状态、连接以及断开过程"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="qq,wechat,facebook,twitter" data-mobile-sites="wechat,qq"></div>
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope="" itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/duckyrain" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li>
        
        <li><a href="http://weibo.com/duqiyu2151" target="_blank" title="Weibo" data-toggle="tooltip" data-placement="top"><i class="icon icon-weibo"></i></a></li>
        
        <li><a href="https://twitter.com/duqiyu2151" target="_blank" title="Twitter" data-toggle="tooltip" data-placement="top"><i class="icon icon-twitter"></i></a></li>
        
        <li><a href="/" target="_blank" title="Facebook" data-toggle="tooltip" data-placement="top"><i class="icon icon-facebook"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script src="/js/plugin.min.js"></script>
<script src="/js/application.js"></script>

    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>





   
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





   
    
<script src="//cdn.jsdelivr.net/npm/gitment@0.0.3/dist/gitment.browser.min.js"></script>
<script>
var gitment = new Gitment({
  // id默认为当前页面url，如果url后带参数或锚点，gitment要重新初始化
  // https://github.com/imsun/gitment/issues/55
  // 解决方案：id:window.location.pathname,或者将id设置为当前页面标题
  id: '基于Logstash、ElasticSearch的全文检索平台', 
  owner: 'duckyrain', // 可以是你的GitHub用户名，也可以是github id
  repo: 'duckyrain.github.io',
  oauth: {
    client_id: '28f5a7640473e0e2fd40',
    client_secret: 'd9b99a7c8a903495c5c567222e94d02e0a9be7dc',
  }
})
gitment.render('comments')
</script>









</body>
</html>